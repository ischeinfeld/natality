---
title: 'US Natality Data: Causal Inference Case Study'
output:
  html_document:
    df_print: paged
---

```{r echo=TRUE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE, comment=NA)

library(ggplot2)   # plot
library(dplyr)     # tables
library(readr)     # reading
library(stringr)   # strings
library(purrr)     # fp
library(tidyr)     # remove_na
library(forcats)   # factor recode
library(glmnet)    # lasso
library(grf)       # random forests
library(janitor)   # remove_constant columns
library(corrplot)  # plot correlation matrix
#library(sufrep)    # sufficient representations
source("make_encoder.R")

rm(list = ls())    # reset environment
source("utils.R")  # import helpers
```

# Subset and preprocess data

```{r}
year <- 2002
```

To begin with we sample 500,000 birth records uniformly at random and preprocess
their columns types from the raw CSV to encode each variable as an integer or 
an ordered or unordered factor. All values coded as missing or undetermined
are considered NA.

```{r}
subset <- FALSE
subset_size <- as.integer(1e5)
subset_fname <- paste0("../data/subset_rds/natl", year, ".rds")

if (subset) {
  raw_fname <- paste0("../data/raw_csv/natl", year, ".csv")
  natl_raw <- 
    read_csv(raw_fname, col_types = cols(.default = col_character())) %>%
    sample_n(subset_size)

  write_rds(natl_raw, subset_fname, compress = "gz")
}
```

```{r}
preprocess <- FALSE

preprocessed_fname <- paste0("../data/preprocessed_rds/natl", year, ".rds")

if (preprocess) {
  # load preprocess_natl for this year
  source(paste0("preprocess/preprocess_natl", year, ".R"))
  
  natl <- read_rds(subset_fname) %>%
    preprocess_natl()
  
  write_rds(natl, preprocessed_fname, compress = "gz")
}

natl_full <- read_rds(preprocessed_fname)
```

# Prepare and Explore Data 

The following variables will be considered in our analysis. Since the original
natality dataset contains multiple codings for the same variables, here we
select a single coding per variable of interest. Some other variables have been
dropped as well, and ?/? of original data covariates are listed. 

```{r}
# variables (with most specific coding) available for analysis
natl_names <- list(
  general = c("restatus",   # Resident Status
              "pldel",      # Place or Facility of Birth
              "birattnd"),  # Attendant at Birth
  occur =   c("stnatexp",   # Expanded State of Occurrence
              "cntocpop"),  # Population Size of County of Occurrence
  resid =   c("stresexp",   # Expanded State of Residence
              "cntrspop",   # Population Size of County of Residence
              "citrspop",   # Population Size of City of Residence
              "metrores",   # Metropolitan - Non-metropolitan County of Residence
              "cntrspop"),  # Population Size of County of Residence
  mother =  c("dmage",      # Age of Mother
              "ormoth",     # Hispanic Origin of Mother
              "mrace",      # Race of Mother
              "dmeduc",     # Education of Mother
              "dmar",       # Marital status
              "mplbir",     # Place of Birth of Mother
              "adequacy",   # Adequacy Of Care Recode (Kessner Index)
              "nlbnl",      # Number of Live Births Now Living
              "nlbnd",      # Number of Live Births Now Dead
              "noterm",     # Number of Other Terminations
              "dlivord",    # Detail Live Birth Order (nlbnl + nlbnd + 1)
              "monpre",     # Detail Month of Pregnancy Prenatal Care Began
              "nprevis"),   # Total Number of Prenatal Visits
  father =  c("dfage",      # Age of Father
              "orfath",     # Hispanic Origin of Father
              "frace"),     # Race of Father
  child =   c("dgestat",    # Gestation - Detail in Weeks
              "csex",       # Sex
              "dbirwt",     # Birth Weight - Detail in Grams
              "dplural",    # Plurality
              "fmaps",      # Five Minute Apgar Score
              "delmeth5"),  # Method of Delivery Recode
  med_rsk = c("anemia", "cardiac", "lung", "diabetes", "herpes", "hydra", "hemo",
              "chyper", "phyper", "eclamp", "incervix", "pre4000", "preterm",
              "renal", "rh", "uterine", "othermr"),
  oth_rsk = c("tobacco",    # Tobacco Use During Pregnancy
              "cigar",      # Average Number of Cigarettes Per Day
              "alcohol",    # Alcohol Use During Pregnancy
              "drink",      # Average Number of Drinks Per Week
              "wtgain"),    # Weight Gain
  obstetr = c("amnio", "monitor", "induct", "stimula", "tocol", "ultras", "otherob"),
  lab_cmp = c("febrile", "meconium", "rupture", "abruptio", "preplace", "excebld",
              "seizure", "precip", "prolong", "dysfunc", "breech", "cephalo",
              "cord", "anesthe", "distress", "otherlb"),
  newborn = c("nanemia", "injury", "alcosyn", "hyaline", "meconsyn", "venl30",
              "ven30m", "nseiz", "otherab"),
  congntl = c("anen", "spina", "hydro", "microce", "nervous", "heart", "circul",
              "rectal", "tracheo", "omphalo", "gastro", "genital", "renalage", 
              "urogen", "cleftlp", "adactyly", "clubfoot", "hernia", "musculo"))

# select data
Xnames <- with(natl_names, c(general, occur, resid, mother, father))
Yname <- "dbirwt"
Wname <- "tobacco"

# filter to data with available Y, W
natl <- natl_full %>%
  select(all_of(c(Yname, Wname, Xnames))) %>%
  drop_na(all_of(c(Yname, Wname)))
```

As a sanity check for our preprocessing and to start exploring the data, we
tabulate some quick summary information.

```{r}
natl %>%
  summarise(across(.fns = function (x) sum(is.na(x)) / length(x))) %>%
  pivot_longer(cols = everything()) %>%
  arrange(desc(value)) %>%
  head(8)
```

The top 5 missing variables are mother's place of birth, population size of 
county of occurrence, and fathers race, origin, and age. All other variables
are missing less than in less than 5% of samples. 

Note that missing values in this dataset can be due to a variety of factors. A
large proportion of missingness is explained by regional variations in reporting,
leading to the highly structured correlation of missing values. TODO rework.

```{r}
M <- natl %>%
  sample_n(1000) %>%
  summarise(across(.fns = is.na)) %>%
  remove_constant() %>%
  cor()

corrplot(M, method="circle", order="hclust", type="lower")
```

# Factor representation

Our models will require exclusively numeric-valued inputs, and we therefore need
to encode group-valued variables as numeric. First we split the data into 
variables that can be directly converted to numbers (i.e.numeric values, ordered
factors, and binary factors) from those that require group encoding.

```{r}
natl_num <- natl %>% 
  select_if(is.numeric)

natl_ord <- natl %>% 
  select_if(function (col) (is.factor(col) && is.ordered(col))) %>%
  transmute(across(everything(), as.numeric))

natl_bin <- natl %>% 
  select_if(function (col) (is.factor(col) && nlevels(col) == 2)) %>%
  transmute(across(everything(), function(col) col == "yes"))

natl_num <- bind_cols(natl_num, natl_ord, natl_bin)

natl_grp <- natl %>%
  select(-one_of(names(natl_num)))

ncol(natl_num)
ncol(natl_grp)
```

Note that simply using one-hot encoding would massively expands the number of 
variables since some of our group variables have many levels (i.e. 50+ states). 

```{r}
natl_grp_nlevels <- sapply(natl_grp, nlevels)
natl_grp_nlevels
```

Most of the one-hot dimensions come from `stnatexp`, `stresexp`, and `mplbir`,
all of which are geographic variables. The race variables `mrace` and `frace`
also contribute many group levels / dimensions. For these variables specifically,
it would be helpful to use alternate encodings.

One alternate class of encoding schemes, sufficient representations, are 
described in (TODO cite). We define different encoding types for the group
variables based on their level counts.

```{r}
natl_grp_encoding_types <- natl_grp_nlevels %>%
  map(function(size) {
    if (size < 10) "one_hot" else "sparse_low_rank"
  })
```

We then generate encoders of these types.

```{r}
source("make_encoder.R")

natl_grp_encoders <- map2(natl_grp_encoding_types, natl_grp,
  function(encoding, G) {
    make_encoder(encoding, X = as.matrix(natl_num), G = G, num_components = 3)
  })
```

And generate the corresponding encodings.

```{r}
natl_grp_encodings <- natl_grp_encoders %>%
  map2(natl_grp, 
       ~ as.data.frame(.x(X = as.matrix(natl_num), .y))) %>%
  map2_dfc(names(natl_grp), 
       ~ rename_with(.x, function (x) paste(.y, 1:length(.x), sep=".")))
```

Finally, we recombine with the numeric variables to give our data matrix.

```{r}
natl_rep <- bind_cols(natl_num, natl_grp_encodings)
head(natl_rep)
```

# Analyses

```{r}
Xmod <- as.matrix(natl_rep %>% select(-all_of(c(Yname, Wname))))
Ymod <- natl_rep[[Yname]]
Wmod <- natl_rep[[Wname]]
```

```{r}
tau.forest <- causal_forest(Xmod, Ymod, Wmod)
```

```{r}
average_treatment_effect(
  tau.forest,
  target.sample = "all",
  method = "AIPW",
  subset = NULL
)
```

```{r}
average_treatment_effect(
  tau.forest,
  target.sample = "treated",
  method = "AIPW",
  subset = NULL
)
```

```{r}
tau.hat <- predict(tau.forest)$predictions
hist(tau.hat)
```

```{r}
importance <- variable_importance(tau.forest)
perm <- order(as.vector(importance), decreasing = TRUE)
vars <- colnames(Xmod)[perm]
importance <- importance[perm]

tibble(vars = vars, importance = importance) %>%
  head(10)
```
